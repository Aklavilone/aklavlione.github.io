<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#fff1f2" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="–ù–µ–∂–Ω—ã–π –î–µ–Ω—å">

  <!-- –ò–ö–û–ù–ö–ò (—Ä–µ–∞–ª—å–Ω—ã–µ PNG-—Ñ–∞–π–ª—ã) -->
  <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">

  <link rel="manifest" href="manifest.webmanifest" />

  <!-- –ù–µ–∂–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;600&family=Dancing+Script:wght@600;700&display=swap" rel="stylesheet">

  <title>–ù–µ–∂–Ω—ã–π –î–µ–Ω—å ‚Äî PWA</title>

  <style>
    :root{
      --pink-50:#fff1f2;
      --pink-100:#ffe4e6;
      --pink-200:#fecdd3;
      --accent:#fb7185;
      --text:#374151;
      --muted:#6b7280;
      --gray-dark:#1f2937;
      --gray:#9ca3af;
      --gray-light:#e5e7eb;
      --radius:14px;
      --fade-ms:1000ms;
    }
    *{box-sizing:border-box}

    /* –§–æ–Ω —Ç—è–Ω–µ—Ç—Å—è –Ω–∞ –¥–ª–∏–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö (iOS fix) */
    html, body{ min-height:100%; height:auto; }
    html{
      background: linear-gradient(180deg,var(--pink-50),var(--pink-100) 60%, var(--pink-200));
      background-repeat:no-repeat;
    }
    body{
      margin:0;
      font-family:'Comfortaa', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
      background:inherit;
      -webkit-tap-highlight-color:transparent;
    }

    #app{ min-height:100svh; display:flex; flex-direction:column; }
    .container{ flex:1; display:flex; align-items:stretch; justify-content:center; padding:24px; }

    /* –¢–æ–ø–±–∞—Ä —Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É */
    .topbar{
      position:fixed;
      top:env(safe-area-inset-top, 0);
      left:env(safe-area-inset-left, 0);
      right:env(safe-area-inset-right, 0);
      height:56px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding:0 12px;
      z-index:20;
      background:transparent;
      pointer-events:none;
    }
    .btn-days{
      pointer-events:auto;
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(251,113,133,0.4);
      color:var(--accent);
      background:rgba(255,241,242,0.6);
      backdrop-filter:saturate(150%) blur(6px);
      padding:8px 12px;
      border-radius:12px;
      font-size:14px;
      text-decoration:none;
      user-select:none;
    }
    .btn-days:active{transform:translateY(1px)}

    /* –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω */
    .start{
      display:flex; flex-direction:column; align-items:center; gap:18px;
      text-align:center; max-width:520px; width:100%;
      user-select:none; margin:auto;
    }
    .hello{
      font-family:'Dancing Script','Comfortaa',cursive;
      font-size:56px; line-height:1.1;
      color:#be123c; text-shadow:0 2px 0 rgba(255,255,255,0.6);
    }
    .btn-primary{
      font:600 16px/1 'Comfortaa', sans-serif;
      padding:14px 22px;
      border:1.5px solid rgba(55,65,81,0.2);
      background:#fff; color:var(--text);
      border-radius:var(--radius);
      min-width:220px; cursor:pointer;
      transition:box-shadow .2s ease, transform .2s ease, opacity .2s ease;
      user-select:none;
    }
    .btn-primary:active{transform:translateY(1px)}
    .hint{ font-size:12px; color:var(--muted); }
    .fade-out{ opacity:0; transform:translateY(8px); transition:opacity var(--fade-ms) ease, transform var(--fade-ms) ease; }
    .hidden{display:none !important}

    /* –≠–∫—Ä–∞–Ω –¥–Ω—è */
    .day{
      position:relative; width:100%; min-height:100%;
      display:flex; align-items:center; justify-content:center;
    }
    .media{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover; object-position:center;
      background:#fff;
      touch-action:manipulation;
      -webkit-user-select:none; user-select:none;
    }
    .caption{
      position:absolute; left:16px; right:16px; bottom:24px;
      padding:10px 14px; border-radius:16px;
      background:rgba(255,241,242,0.86); color:#991b1b;
      font-family:'Dancing Script','Comfortaa',cursive;
      font-size:22px; text-align:center;
      box-shadow:0 6px 20px rgba(251,113,133,0.22);
      backdrop-filter:blur(8px);
      z-index:4;
    }

    /* –°—Ç—Ä–µ–ª–∫–∏-–Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –¥–Ω—è–º */
    .nav-arrow{
      position:absolute; top:50%; transform:translateY(-50%);
      width:44px; height:44px;
      display:flex; align-items:center; justify-content:center;
      font-size:22px; line-height:1; font-weight:700;
      color:var(--accent);
      background:rgba(255,241,242,0.6);
      border:1px solid rgba(251,113,133,0.4);  /* —Ä–∞–º–∫–∞ –∫–∞–∫ —É –∫–Ω–æ–ø–∫–∏ ¬´–î–Ω–∏¬ª */
      border-radius:12px;
      box-shadow:0 6px 16px rgba(251,113,133,0.18);
      user-select:none; cursor:pointer; z-index:5;
      backdrop-filter:saturate(150%) blur(6px);
    }
    .nav-arrow:active{ transform:translateY(-50%) scale(0.98); }
    .nav-arrow.left{ left:10px; }
    .nav-arrow.right{ right:10px; }

    /* –≠–∫—Ä–∞–Ω ¬´–î–Ω–∏¬ª */
    .days{ width:100%; max-width:900px; margin:70px auto 24px; padding:0 16px; }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(96px,1fr)); gap:12px; }
    @media (max-width:420px){ .grid{ grid-template-columns:repeat(3,1fr);} }
    .tile{
      position:relative; aspect-ratio:1/1; border-radius:14px; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:22px; color:#fff; cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease, opacity .2s ease; user-select:none;
    }
    .tile:active{transform:scale(0.98)}
    .tile .num{ position:relative; z-index:2; text-shadow:0 2px 8px rgba(0,0,0,.35) }
    .tile.available{ background:#111827; }
    .tile.future{ background:var(--gray-light); color:#6b7280; pointer-events:none; cursor:default; opacity:.8; }
    .tile.viewed{ background:#000; color:#fff; }
    .tile.viewed .bg{
      position:absolute; inset:0; background-size:cover; background-position:center;
      filter:blur(8px); transform:scale(1.05); opacity:.9;
    }
    .tile.viewed::after{ content:""; position:absolute; inset:0; background:linear-gradient(to bottom, rgba(0,0,0,.3), rgba(0,0,0,.45)); }

    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
    a,button{ -webkit-user-select:none; user-select:none; }
    img{ -webkit-user-drag:none; }
  </style>
</head>
<body>
  <div id="app" aria-live="polite">
    <div class="topbar" role="navigation" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
      <a class="btn-days" href="#/days" aria-label="–û—Ç–∫—Ä—ã—Ç—å –æ–±–∑–æ—Ä –¥–Ω–µ–π"><span aria-hidden="true">üìÖ</span> <span>–î–Ω–∏</span></a>
    </div>
    <main class="container" id="view"></main>
  </div>

  <script type="module">
    import { CONTENT } from './content.js?v=3';

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(console.error));
    }

    const VIEWED_KEY = 'viewedDates';
    const STARTED_KEY = 'startedFlag';
    const store = {
      get viewed(){ try { return JSON.parse(localStorage.getItem(VIEWED_KEY)||'[]'); } catch { return []; } },
      set viewed(v){ localStorage.setItem(VIEWED_KEY, JSON.stringify(Array.from(new Set(v)))); },
      get started(){ return sessionStorage.getItem(STARTED_KEY) === '1'; },
      set started(v){ v ? sessionStorage.setItem(STARTED_KEY,'1') : sessionStorage.removeItem(STARTED_KEY); }
    };

    /** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç "YYYY-MM-DD" —Å –ø–æ—Ä–æ–≥–æ–º 08:00 MSK */
    function getEffectiveMoscowDate(){
      const now = new Date();
      const parts = new Intl.DateTimeFormat('ru-RU', {
        timeZone:'Europe/Moscow', hour12:false,
        year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'
      }).formatToParts(now);
      const get = t => +parts.find(p=>p.type===t).value;
      let y=get('year'), m=get('month'), d=get('day');
      const hour=get('hour');
      if (hour < 8){ const p=prevDate(y,m,d); y=p.y; m=p.m; d=p.d; }
      return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }
    function isLeap(y){ return (y%4===0 && y%100!==0) || (y%400===0); }
    function dim(y,m){ return [0,31,isLeap(y)?29:28,31,30,31,30,31,31,30,31,30,31][m]; }
    function prevDate(y,m,d){ if(d>1) return {y,m,d:d-1}; if(m>1){const pm=m-1; return {y,m:pm,d:dim(y,pm)};} return {y:y-1,m:12,d:31}; }

    const $view = document.getElementById('view');
    window.addEventListener('hashchange', route);
    window.addEventListener('load', route);
    function route(){
      const hash = location.hash || '#/start';
      const [_, root, param] = hash.split('/');
      switch(root){
        case 'start': renderStart(); break;
        case 'today': renderToday(); break;
        case 'days': renderDays(); break;
        case 'day'  : renderDay(param); break;
        default: location.hash = '#/start';
      }
    }

    function renderStart(){
      $view.innerHTML = `
        <section class="start" id="start">
          <h1 class="hello" aria-label="–ü—Ä–∏–≤–µ—Ç, —á—ë—Ä–Ω–æ–µ —Å–µ—Ä–¥–µ—á–∫–æ">–ü—Ä–∏–≤–µ—Ç üñ§</h1>
          <button class="btn-primary" id="continueBtn" type="button">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          <div class="hint">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí –ù–∞ —ç–∫—Ä–∞–Ω ‚Äú–î–æ–º–æ–π‚Äù ‚Üí –î–æ–±–∞–≤–∏—Ç—å.</div>
          <div class="sr-only">–ù–∞–∂–º–∏—Ç–µ ¬´–î–Ω–∏¬ª –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –æ–±–∑–æ—Ä –Ω–∞ 30 –¥–Ω–µ–π.</div>
        </section>`;
      const startEl = document.getElementById('start');
      document.getElementById('continueBtn').addEventListener('click', ()=>{
        startEl.classList.add('fade-out');
        store.started = true;
        setTimeout(()=>{ location.hash = '#/today'; }, 1000);
      });
    }

    function renderToday(){
      const effective = getEffectiveMoscowDate();
      const item = CONTENT.find(x => x.date === effective);
      if (!item) {
        $view.innerHTML = `<section class="day"><div class="caption">–ù–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è ${effective}. –ó–∞–º–µ–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ <code>content.js</code>.</div></section>`;
        return;
      }
      renderDay(item.date, true);
    }

    function renderDay(dateStr, markFromToday=false){
      const idx = CONTENT.findIndex(x => x.date === dateStr);
      const item = CONTENT[idx];
      if (idx === -1 || !item) {
        $view.innerHTML = `<section class="day"><div class="caption">–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (${dateStr}). –û–±–Ω–æ–≤–∏—Ç–µ <code>content.js</code>.</div></section>`;
        return;
      }
      const effective = getEffectiveMoscowDate();
      const canPrev = idx > 0;
      const canNext = idx < CONTENT.length - 1 && CONTENT[idx + 1].date <= effective; // –ø—Ä–∞–≤–∞—è —Å—Ç—Ä–µ–ª–∫–∞ –ø—Ä–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ ¬´—Å–µ–≥–æ–¥–Ω—è¬ª

      $view.innerHTML = `
        <section class="day" aria-label="–≠–∫—Ä–∞–Ω –¥–Ω—è">
          <img class="media" alt="–ö–∞—Ä—Ç–∏–Ω–∫–∞ –¥–Ω—è ${dateStr}" src="${item.img}" id="media"/>
          <button class="nav-arrow left ${canPrev?'':'hidden'}" id="prevBtn" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å">‚Äπ</button>
          <button class="nav-arrow right ${canNext?'':'hidden'}" id="nextBtn" aria-label="–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å" title="–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å">‚Ä∫</button>
          <div class="caption" id="caption">${escapeHtml(item.caption)}</div>
        </section>
      `;

      if (store.started && (markFromToday || location.hash.startsWith('#/day/'))) {
        const v = store.viewed; if (!v.includes(dateStr)) { v.push(dateStr); store.viewed = v; }
      }

      // –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∞–º–∏
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      if (canPrev && prevBtn) {
        prevBtn.addEventListener('click', () => {
          const prevDateStr = CONTENT[idx - 1].date;
          location.hash = '#/day/' + prevDateStr;
        });
      }
      if (canNext && nextBtn) {
        nextBtn.addEventListener('click', () => {
          const nextDateStr = CONTENT[idx + 1].date;
          location.hash = '#/day/' + nextDateStr;
        });
      }

      // –ù–µ–±–æ–ª—å—à–æ–π —Å–≤–∞–π–ø-–∂–µ—Å—Ç (–ø–æ –∂–µ–ª–∞–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è; –±–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫)
      let touchX=null;
      $view.querySelector('.day').addEventListener('touchstart', e=>{ touchX = e.changedTouches[0].clientX; }, {passive:true});
      $view.querySelector('.day').addEventListener('touchend', e=>{
        if (touchX==null) return;
        const dx = e.changedTouches[0].clientX - touchX;
        const thresh = 40; // ¬´—Ä–∞–∑—É–º–Ω–æ–µ¬ª –∑–Ω–∞—á–µ–Ω–∏–µ
        if (dx > thresh && canPrev) prevBtn?.click();
        else if (dx < -thresh && canNext) nextBtn?.click();
        touchX=null;
      }, {passive:true});
    }

    function renderDays(){
      const effective = getEffectiveMoscowDate();
      const viewed = new Set(store.viewed);
      const tiles = CONTENT.map((c, idx) => {
        const isFuture = c.date > effective;
        const isViewed = viewed.has(c.date);
        const cls = ['tile', isFuture ? 'future' : (isViewed ? 'viewed' : 'available')].join(' ');
        const bg  = isViewed ? `<div class="bg" style="background-image:url('${c.img}')"></div>` : '';
        return `<div class="${cls}" data-date="${c.date}" ${isFuture?'aria-disabled="true"':''} role="button" tabindex="${isFuture?'-1':'0'}">${bg}<div class="num">${idx+1}</div></div>`;
      }).join('');
      $view.innerHTML = `<section class="days" aria-label="–û–±–∑–æ—Ä –Ω–∞ 30 –¥–Ω–µ–π"><div class="grid">${tiles}</div></section>`;
      $view.querySelectorAll('.tile.available, .tile.viewed').forEach(t=>{
        t.addEventListener('click', ()=> location.hash = '#/day/' + t.getAttribute('data-date'));
        t.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); t.click(); }});
      });
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    if (!location.hash) location.hash = '#/start';
    (function iosTheme(){ const m=document.querySelector('meta[name="theme-color"]'); if (m) m.setAttribute('content', '#fff1f2'); })();
  </script>
</body>
</html>
